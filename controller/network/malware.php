<?php
$pa = new PaloAltoAPI();
$table = "maliciousSite"; // 設定你想查詢資料的資料表

$db->query($table, $condition = "Type LIKE :Type", $order_by ="1", $fields ="*", $limit = "", [':Type'=>'domain']);
$total_dn_query_num = $db->getLastNumRows();
$condition = "Type LIKE :Type and Action LIKE :Action";
$order_by = "1";
$DNs = $db->query($table, $condition, $order_by, $fields = "*", $limit = "", [':Type'=>'domain', ':Action'=>'allow']);
$allow_dn_query_num = $db->getLastNumRows();
$last_dn_update = $db->query($table, $condition = "Type LIKE :Type", $order_by ="1", $fields ="*", $limit = "LIMIT 1", [':Type'=>'domain'])[0]['LastUpdate'];

$db->query($table, $condition = "Type LIKE :Type", $order_by ="1", $fields ="*", $limit = "", [':Type'=>'ip']);
$total_ip_query_num = $db->getLastNumRows();
$condition = "Type LIKE :Type and Action LIKE :Action";
$order_by = "1";
$IPs = $db->query($table, $condition, $order_by, $fields = "*", $limit = "", [':Type'=>'ip', ':Action'=>'allow']);
$allow_ip_query_num = $db->getLastNumRows();
$last_ip_update = $db->query($table, $condition = "Type LIKE :Type", $order_by ="1", $fields ="*", $limit = "LIMIT 1", [':Type'=>'ip'])[0]['LastUpdate'];

$object_type = 'ExternalDynamicLists'; 
$name = '';
$res = $pa->GetObjectList($object_type, $name);
$res = json_decode($res);
$entries = $res->result->entry;
$entry_array = array();
$show_records = 10;
foreach($entries as $index => $entry){
    $name = $entry->{'@name'};
    $type = $entry->{'type'};
    $num_records = 1;
    foreach($type as $type_name => $val){
        $type = $type_name;
    }
    $xml_type = "op";
    $cmd = "<request><system><external-list><show><type><".$type."><name>".$name."</name><num-records>".$num_records."</num-records></".$type."></type></show></external-list></system></request>";
    $record = $pa->GetXmlCmdResponse($xml_type, $cmd);
    $xml = simplexml_load_string($record) or die("Error: Cannot create object");

    $entry_array[$index]['status'] = $xml['status'];
    $entry_array[$index]['name'] = $name;
    if($xml['status'] != 'success'){
        continue ;
    }
    $total_count = $xml->result['total-count'];
    $cmd = "<request><system><external-list><show><type><".$type."><name>".$name."</name><num-records>".$total_count."</num-records></".$type."></type></show></external-list></system></request>";
    $record = $pa->GetXmlCmdResponse($xml_type, $cmd);
    $xml = simplexml_load_string($record) or die("Error: Cannot create object");
    $members = $xml->result->{'external-list'}->{'valid-members'}->member; 
    $entry_array[$index]['total_count'] = $total_count;
    $entry_array[$index]['members'] = $members;
}

require 'view/header/default.php'; 
require 'view/body/network/malware.php';
require 'view/footer/default.php'; 
