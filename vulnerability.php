<!--vulnerability.php-->
<div id="content">
		<div class="sub-content show">
			<div class="post">
				<div class="post_title">OverView(OU)</div>
				<div class="ou_vs_content"></div>
			</div>
		</div>
		<div class="sub-content">
			<div class="post ipscanResult">
				<div class="post_title">ipscanResult</div>
				<form class="ui form" action="javascript:void(0)">
 				<div class="fields">
			    	<div class="field">
					    <label>種類</label>
						<select name="keyword_type" id="keyword_type" class="ui fluid dropdown" required>
						<option value="ou" class="keyword_paper active" selected>單位</option>
						<option value="system_name" class="keyword_paper active">系統名稱</option>
						<option value="severity" class="keyword_paper active">風險程度</option>
						<option value="all" class="keyword_paper active">全部</option>
						</select>
					</div>
				 	<div class="field">
					    <label>關鍵字</label>
						<div class="ui input">
							<input type='text' name='key' id='key' placeholder="請輸入關鍵字">
						</div>
					</div>

				 	<div class="field">
						<div class="ui checkbox">
						  <input type="checkbox" name="status[]" tabindex="0" checked>
						  <label>待處理</label>
						</div>
						<div class="ui checkbox">
						  <input type="checkbox" name="status[]" tabindex="0" checked>
						  <label>已修補</label>
						</div>
					</div>

					<div class="field">
						<button id="search_btn" name="search_btn" class="ui button">搜尋</button>
					</div>
					 <div class="field">
						<button id="show_all_btn" class="ui button" onclick="window.location.href='index.php?mainpage=vulnerability&subpage=2'">顯示全部</button>
					</div>
				</div>
				</form>
				

				
				<div class="record_content">
                <?php //select data form database
                    require("mysql_connect.inc.php");
				    //------------pagination----------//
                    $pages=" ";
                    if (!isset($_GET['page'])){ 
                        $pages = 1; 
                    }else{
                        $pages = $_GET['page']; 
                    }
                    
                    //select row_number,and other field value
                    $sql = "SELECT * FROM ipscanResult ORDER BY ou desc,system_name desc,scan_no desc,status desc";
                        
                    $result = mysqli_query($conn,$sql);
                    $rowcount = mysqli_num_rows($result);
                     
                    $per = 10; 		
                    $max_pages = 10;
                    $Totalpages = ceil($rowcount / $per); 
                    $lower_bound = ($pages <= $max_pages) ? 1 : $pages - $max_pages + 1;
                    $upper_bound = ($pages <= $max_pages) ? min($max_pages,$Totalpages) : $pages;					
                    $start = ($pages -1)*$per; //計算資料庫取資料範圍的開始值。
                    if($pages == 1)					$offset = ($rowcount < $per) ? $rowcount : $per;
                    elseif($pages == $Totalpages)	$offset = $rowcount - $start;
                    else							$offset = $per;
                                
                    $prev_page = ($pages > 1) ? $pages -1 : 1;
                    $next_page = ($pages < $Totalpages) ? $pages +1 : $Totalpages;	
                    $sql_subpage = $sql." limit ".$start.",".$offset;
                                
                    $result = mysqli_query($conn,$sql_subpage);
                                        
                    if($rowcount==0){
                        echo "查無此筆紀錄";
                    }else{
                        echo "共有".$rowcount."筆資料！";


						echo "<div class='ui relaxed divided list'>";
							echo "<div class='item'>";
								echo "<div class='content'>";
									echo "<a class='header'>";
									//echo "序號&nbsp";
                        			echo "單位&nbsp&nbsp";
                        			echo "系統名稱&nbsp&nbsp";
                        			echo "處理狀態&nbsp&nbsp";
                       				echo "弱點名稱&nbsp&nbsp";
									echo "掃描期別&nbsp&nbsp";
									echo "<a>";
								echo "</div>";
							echo "</div>";

                    while($row = mysqli_fetch_assoc($result)) {
						echo "<div class='item'>";
						echo "<div class='content'>";
							echo "<a>";
							echo str_replace("/臺南市政府/","",$row['ou'])."&nbsp&nbsp";
							echo "<span style='background:#fde087'>".$row['system_name']."</span>&nbsp&nbsp";
							echo $row['status']."&nbsp&nbsp";
							echo "<span style='background:#DDDDDD'>".$row['vitem_name']."</span>&nbsp&nbsp";
							echo $row['scan_no']."&nbsp&nbsp";
					
				
							echo "<i class='angle double down icon'></i>";
							echo "</a>";
							echo "<div class='description'>";
							 
								echo "<ol>";
								echo "<li>弱點序號:".$row['vitem_id']."</li>";
								echo "<li>弱點名稱:".$row['vitem_name']."</li>";
								echo "<li>單位:".str_replace("/臺南市政府/","",$row['ou'])."</li>";
								echo "<li>系統名稱:".$row['system_name']."</li>";
								echo "<li>IP:".$row['ip']."</li>";
								echo "<li>掃描日期:".date_format(new DateTime($row['scan_date']),'Y-m-d')."</li>";
								echo "<li>管理員:".$row['manager']."</li>";
								echo "<li>Email:".$row['email']."</li>";
								echo "<li>弱點詳細資訊:<a href='".$row['url']."' target='_blank'>".$row['url']."</a></li>";
								echo "<li>總類:".$row['category']."</li>";
								echo "<li>風險程度:".$row['severity']."</li>";
								echo "<li>掃描期別:".$row['scan_no']."</li>";
								echo "</ol>";
							  
							echo "</div>";
							echo "</div>";
						echo "</div>";
                    }
					
					echo "</div>";
                                            
                    //The href-link of bottom pages
                    echo "<div class='ui pagination menu'>";	
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=2&page=1'>首頁</a>";
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$prev_page."'> ← </a>";
                    for ($j = $lower_bound; $j <= $upper_bound ;$j++){
                        if($j == $pages){
                            echo"<a class='active item bold' href='?mainpage=vulnerability&subpage=2&page=".$j."'>".$j."</a>";
                        }else{
                            echo"<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$j."'>".$j."</a>";
                        }
                    }
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$next_page."'> → </a>";		
                    //last page
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$Totalpages."'>末頁</a>";
                    echo "</div>";
				   
                    //The mobile href-link of bottom pages
                    echo "<div class='ui pagination menu mobile'>";	
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$prev_page."'> ← </a>";
                    echo"<a class='active item bold' href='?mainpage=vulnerability&subpage=2&page=".$pages."'>(".$pages."/".$Totalpages.")</a>";
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=2&page=".$next_page."'> → </a>";		
                    echo "</div>";
				
				
					}
                    $conn->close();
                ?>
				</div>

						
			</div>
		</div>
		<div class="sub-content">
			<div class="post urlscanResult">
				<div class="post_title">urlResult</div>
				<form class="ui form" action="javascript:void(0)">
 				<div class="fields">
			    	<div class="field">
					    <label>種類</label>
						<select name="keyword_type" id="keyword_type" class="ui fluid dropdown" required>
						<option value="ou" class="keyword_paper active" selected>單位</option>
						<option value="system_name" class="keyword_paper active">系統名稱</option>
						<option value="severity" class="keyword_paper active">風險程度</option>
						<option value="all" class="keyword_paper active">全部</option>
						</select>
					</div>
				 	<div class="field">
					    <label>關鍵字</label>
						<div class="ui input">
							<input type='text' name='key' id='key' placeholder="請輸入關鍵字">
						</div>
					</div>

				 	<div class="field">
						<div class="ui checkbox">
						  <input type="checkbox" name="status[]" tabindex="0" checked>
						  <label>待處理</label>
						</div>
						<div class="ui checkbox">
						  <input type="checkbox" name="status[]" tabindex="0" checked>
						  <label>已修補</label>
						</div>
					</div>

					<div class="field">
						<button id="search_btn" name="search_btn" class="ui button">搜尋</button>
					</div>
					 <div class="field">
						<button id="show_all_btn" class="ui button" onclick="window.location.href='index.php?mainpage=vulnerability&subpage=3'">顯示全部</button>
					</div>
				</div>
				</form>
				

				
				<div class="record_content">
                <?php //select data form database
                    require("mysql_connect.inc.php");
                    //------------pagination----------//
                    $pages=" ";
                    if (!isset($_GET['page'])){ 
                        $pages = 1; 
                    }else{
                        $pages = $_GET['page']; 
                    }
                    
                    //select row_number,and other field value
                    $sql = "SELECT * FROM urlscanResult ORDER BY ou desc,system_name desc,scan_no desc,status desc";
                        
                    $result = mysqli_query($conn,$sql);
                    $rowcount = mysqli_num_rows($result);
                     
                    $per = 10; 		
                    $max_pages = 10;
                    $Totalpages = ceil($rowcount / $per); 
                    $lower_bound = ($pages <= $max_pages) ? 1 : $pages - $max_pages + 1;
                    $upper_bound = ($pages <= $max_pages) ? min($max_pages,$Totalpages) : $pages;					
                    $start = ($pages -1)*$per; //計算資料庫取資料範圍的開始值。
                    if($pages == 1)					$offset = ($rowcount < $per) ? $rowcount : $per;
                    elseif($pages == $Totalpages)	$offset = $rowcount - $start;
                    else							$offset = $per;
                                
                    $prev_page = ($pages > 1) ? $pages -1 : 1;
                    $next_page = ($pages < $Totalpages) ? $pages +1 : $Totalpages;	
                    $sql_subpage = $sql." limit ".$start.",".$offset;
                                
                    $result = mysqli_query($conn,$sql_subpage);
                                        
                    if($rowcount==0){
                        echo "查無此筆紀錄";
                    }else{
                        echo "共有".$rowcount."筆資料！";


						echo "<div class='ui relaxed divided list'>";
							echo "<div class='item'>";
								echo "<div class='content'>";
									echo "<a class='header'>";
									//echo "序號&nbsp";
                        			echo "單位&nbsp&nbsp";
                        			echo "系統名稱&nbsp&nbsp";
                        			echo "處理狀態&nbsp&nbsp";
                       				echo "弱點名稱&nbsp&nbsp";
									echo "掃描期別&nbsp&nbsp";
									echo "<a>";
								echo "</div>";
							echo "</div>";

                    while($row = mysqli_fetch_assoc($result)) {
						echo "<div class='item'>";
						echo "<div class='content'>";
							echo "<a>";
                        	//echo date_format(new DateTime($row['OccurrenceTime']),'Y-m-d')."&nbsp&nbsp";
							echo str_replace("/臺南市政府/","",$row['ou'])."&nbsp&nbsp";
							echo "<span style='background:#fde087'>".$row['system_name']."</span>&nbsp&nbsp";
							echo $row['status']."&nbsp&nbsp";
							echo "<span style='background:#DDDDDD'>".$row['vitem_name']."</span>&nbsp&nbsp";
							echo $row['scan_no']."&nbsp&nbsp";
					
				
							echo "<i class='angle double down icon'></i>";
							echo "</a>";
							echo "<div class='description'>";
							 
								echo "<ol>";
								echo "<li>弱點序號:".$row['vitem_id']."</li>";
								echo "<li>弱點名稱:".$row['vitem_name']."</li>";
								echo "<li>單位:".str_replace("/臺南市政府/","",$row['ou'])."</li>";
								echo "<li>系統名稱:".$row['system_name']."</li>";
								echo "<li>IP:".$row['ip']."</li>";
								echo "<li>掃描日期:".date_format(new DateTime($row['scan_date']),'Y-m-d')."</li>";
								echo "<li>管理員:".$row['manager']."</li>";
								echo "<li>Email:".$row['email']."</li>";
								echo "<li>影響網址:<a href='".$row['affect_url']."' target='_blank'>".$row['affect_url']."</a></li>";
								echo "<li>弱點詳細資訊:<a href='".$row['url']."' target='_blank'>".$row['url']."</a></li>";
								echo "<li>總類:".$row['category']."</li>";
								echo "<li>風險程度:".$row['severity']."</li>";
								echo "<li>掃描期別:".$row['scan_no']."</li>";
								echo "</ol>";
							  
							echo "</div>";
							echo "</div>";
						echo "</div>";
                    }
					
					echo "</div>";
                                            
                    //The href-link of bottom pages
                    echo "<div class='ui pagination menu'>";	
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=3&page=1'>首頁</a>";
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$prev_page."'> ← </a>";
                    for ($j = $lower_bound; $j <= $upper_bound ;$j++){
                        if($j == $pages){
                            echo"<a class='active item bold' href='?mainpage=vulnerability&subpage=3&page=".$j."'>".$j."</a>";
                        }else{
                            echo"<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$j."'>".$j."</a>";
                        }
                    }
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$next_page."'> → </a>";		
                    //last page
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$Totalpages."'>末頁</a>";
                    echo "</div>";
				   
                    //The mobile href-link of bottom pages
                    echo "<div class='ui pagination menu mobile'>";	
                    echo "<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$prev_page."'> ← </a>";
                    echo"<a class='active item bold' href='?mainpage=vulnerability&subpage=3&page=".$pages."'>(".$pages."/".$Totalpages.")</a>";
                    echo"<a class='item test' href='?mainpage=vulnerability&subpage=3&page=".$next_page."'> → </a>";		
                    echo "</div>";
				
				
					}
                    $conn->close();
                ?>
				</div>

						
			</div>
		</div>
		<div class="sub-content">
			<div class="post">
				<form class="ui form" action="javascript:void(0)">
				<?php
					require("chtsecurity.inc.php");
					date_default_timezone_set("Asia/Taipei");
					$nowTime 	= date("Y-m-d H:i:s");
					$host_type 	= "ipscanResult";
					$web_type 	= "urlscanResult";
					$host_auth	= hash("sha256",$host_type.$chtsecurity_key.$nowTime);
					$web_auth	= hash("sha256",$web_type.$chtsecurity_key.$nowTime);
					$host_url	= "https://tainan-vsms.chtsecurity.com/cgi-bin/api/portal.pl?type=".$host_type."&nowTime=".$nowTime."&auth=".$host_auth;
					$web_url	= "https://tainan-vsms.chtsecurity.com/cgi-bin/api/portal.pl?type=".$web_type."&nowTime=".$nowTime."&auth=".$web_auth;
				?>
					<div class="field">
						<label>nowTime</label>
						<?php echo $nowTime; ?>
					</div>
					<div class="field">
						<label>host json-url</label>
						<?php echo "<a href='".$host_url."' target='_blank'>".$host_url."</a>"; ?>
					</div>
					<div class="field">
						<label>web json-url</label>
						<?php echo "<a href='".$web_url."' target='_blank'>".$web_url."</a>"; ?>
					</div>
				</form>
				<pre></pre>
				<button id="vs_btn" class="ui button">Retrieve VS</button>
				<div class="ui centered inline loader"></div>
				<div class="retrieve_vs_info"></div>

						
			</div>
		</div>
		<div style="clear: both;">&nbsp;</div>
	</div>
	
		<!-- end #content -->
